---
title: "all regressions"
output: html_document
date: '2022-07-27'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data
```{r}
library(readr)
library(dplyr)
library(tidyr)
twitter <- read_csv("active_learning/twitter_analysis.csv")
indicators <- read_csv("covid_indicators.csv")
```

Lets first just run a regression of daily tally on daily stringency
```{r}
twitter <- pivot_wider(twitter, names_from = class, names_prefix = "n_class_", values_from = n_class)
twitter <- twitter %>% filter(is.na(n_class_0)==TRUE)

for (i in 1:nrow(twitter)){
  for(j in 1:nrow(twitter)){
    if (twitter$Country[i]==twitter$Country[j] &&twitter$date_time[i]==twitter$date_time[j]){
      twitter$n_class_1[j] <-twitter$n_class_1[i]
      twitter$n_class_2[i] <-twitter$n_class_2[j]
    }
  }
}
```

```{r}
twitter <- twitter %>%
  distinct(Country, date_time, .keep_all = TRUE)

mean_1 <- twitter %>% group_by(Country) %>% summarise(mean(n_class_1, na.rm = TRUE))
mean_2 <- twitter %>% group_by(Country) %>% summarise(mean(n_class_2, na.rm = TRUE))
total <- twitter %>% group_by(Country) %>% summarise(mean(n_total, na.rm = TRUE))
colnames(mean_1) <- c("Country", "mean")
colnames(mean_2) <- c("Country", "mean")
colnames(total) <- c("Country", "mean")

for(i in 1:nrow(twitter)){
  for(j in 1:nrow(mean_1)){
    if(is.na(twitter$n_class_1[i])==TRUE && twitter$Country[i] == mean_1$Country[j]){
      twitter$n_class_1[i] <- mean_1$mean[j]
    }
    if(is.na(twitter$n_total[i])==TRUE && twitter$Country[i] == mean_1$Country[j]){
      twitter$n_total[i] <- total$mean[j]
    }
    if(is.na(twitter$n_class_2[i])==TRUE && twitter$Country[i] == mean_2$Country[j]){
      twitter$n_class_2[i] <- mean_2$mean[j]
    }
  }
}
```

```{r}
for (i in 1:nrow(twitter)){
  if(twitter$Country[i] == "AUS"){
    twitter$Country[i] <- "Australia"
  }
  if(twitter$Country[i] == "CAN"){
    twitter$Country[i] <- "Canada"
  }
  if(twitter$Country[i] == "IRE"){
    twitter$Country[i] <- "Ireland"
  }
  if(twitter$Country[i] == "NZ"){
    twitter$Country[i] <- "New Zealand"
  }
  if(twitter$Country[i] == "UK"){
    twitter$Country[i] <- "United Kingdom"
  }
  
}

regress <- merge(twitter, indicators, by.x = c("Country", "date_time"), by.y = c("Country", "Date"), all.x = TRUE)

#this is the starting dataset
head(regress)
```

## First Plot: Daily Count
```{r}
plot <- regress
plot <- plot %>% 
  group_by(date_time) %>%
  mutate(class_1 = sum(n_class_1)) %>%
  mutate(class_2 = sum(n_class_2)) %>%
  mutate(full_n = sum(n_total)) %>%
  distinct(date_time, .keep_all = TRUE)

library(ggplot2)

ggplot(plot, aes(x=date_time)) +
  geom_line(aes(y=class_1, colour = "Class 1"))+
   geom_line(aes(y=class_2, colour = "Class 2")) + xlab("Date") + ylab("Daily Count") + theme_classic()
```

## First Regression: Daily COunt
```{r}
library(lme4)
# Run random intercept model
model <- lmer(relative_stringency ~ others_stringency + n_class_1 + n_class_2 + (1 | Country), data=regress)
summary(model)

stargazer::stargazer(model, type = "latex", out = "final_tables/1_daily_count.html", title = "Daily Count", covariate.labels = c("Average Western Stringency", "Class 1 Count", "Class 2 Count"), dep.var.labels = c("Relative Stringency"))
```

### Moving into proportions
Next step: the proportions
```{r}
library(dplyr)

regress$prop_1 <- regress$n_class_1 / regress$n_total
regress$prop_2 <- regress$n_class_2 / regress$n_total

#multiplying by 100 so its a percent and not proportion
regress$prop_1 <- regress$prop_1*100
regress$prop_2 <- regress$prop_2*100
```

## Plot 2: Daily Proportion
```{r}
library(ggplot2)
plot <- regress %>% 
  group_by(date_time) %>%
  mutate(prop_1 = sum(n_class_1)/sum(n_total)) %>%
  mutate(prop_2 = sum(n_class_2)/sum(n_total)) %>%
  distinct(date_time, .keep_all = TRUE)

ggplot(plot, aes(x=date_time)) +
  geom_line(aes(y=prop_1, colour = "Class 1"))+
   geom_line(aes(y=prop_2, colour = "Class 2")) + xlab("Date") + ylab("Daily Proportion") + theme_classic()
```

## Weekly averages

```{r}
regress$week_num <- strftime(regress$date_time, format = "%V")
regress$week_num <- as.integer(regress$week_num)
for (i in 1:nrow(regress)){
  if(regress$week_num[i] < 14){
    regress$week_num[i] <- regress$week_num[i] + 53
    
  }
}

regress$week_num <- regress$week_num - 13
```

```{r}
weekly <- regress %>%
  group_by(Country, week_num) %>%
  mutate(week_prop_1 = mean(prop_1))%>%
  mutate(week_prop_2 = mean(prop_2))%>%
  mutate(week_rel_stringency = mean(relative_stringency))%>%
  mutate(week_oth_stringency = mean(others_stringency))%>%
  mutate(week_stringency = mean(stringency_index))%>%
  mutate(week_risk = mean(openness_risk)) %>%
  mutate(sum_1 = sum(n_class_1)) %>%
  mutate(sum_2 = sum(n_class_2)) %>%
  mutate(sum_total = sum(n_total))
```

```{r}
weekly <- weekly %>%
  arrange(desc(date_time))

weekly <- weekly %>%
  distinct(Country, week_num, .keep_all = TRUE)

weekly <- weekly %>%
  arrange(date_time)
```

## Plot 2
```{r}
plot <- weekly %>% 
  group_by(date_time) %>%
  mutate(prop_1 = mean(prop_1)) %>%
  mutate(prop_2 = mean(prop_2)) %>%
  distinct(date_time, .keep_all = TRUE)

ggplot(plot, aes(x=date_time)) +
  geom_line(aes(y=prop_1, colour = "Class 1"))+
   geom_line(aes(y=prop_2, colour = "Class 2")) + xlab("Date") + ylab("Weekly Percentage") + theme_classic()
```
##2nd regression table
```{r}
library(lme4)
model1 <- lmer(week_rel_stringency ~ week_oth_stringency + week_prop_1 + week_prop_2 + (1 | Country), data=weekly)
summary(model1)

stargazer::stargazer(model1,type = "latex", out = "final_tables/2_weekly_classes.html", title = "Weekly Proportion", covariate.labels = c("Average Western Stringency", "Class 1 Percent", "Class 2 Percent"), dep.var.labels = c("Relative Stringency"))
```

## Risk Plots
```{r, fig.width=7,fig.height=10}
risk_plot <- ggplot(weekly, aes(x=date_time)) +
  
  geom_line(aes(y=prop_1, colour = "Class 1")) +  theme_classic() +
  geom_line(aes(y=week_risk/20, colour = "Risk of Openness")) + xlab("Date") + ylab("Weekly Proportion")  +
    
  scale_y_continuous(
    
    # Features of the first axis
    name = "Weekly Class Percentage",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*10, name="Risk of Openness") 
  ) 




# Column chart for each type of reaction
risk_plot <- risk_plot +
        facet_wrap(~Country, nrow = 5, scales = "free") 

risk_plot
```

## Stringency Plots
```{r, fig.width=7,fig.height=10}
stringency_plot <- ggplot(weekly, aes(x=date_time)) +
  
  geom_line(aes(y=prop_2, colour = "Class 2")) +  theme_classic() +
  geom_line(aes(y=week_stringency/50, colour = "Stringency Index")) + xlab("Date") + ylab("Weekly Proportion")  +
    
  scale_y_continuous(
    
    # Features of the first axis
    name = "Weekly Class Percentage",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*10, name="Stringency Index") 
  ) 




# Column chart for each type of reaction
stringency_plot <- stringency_plot +
        facet_wrap(~Country, nrow = 5, scales = "free") 

stringency_plot
```

regress risk and stringency on both classes
```{r}
library(lme4)
model1 <- lmer(week_prop_1 ~ week_risk + (1 | Country), data=weekly)
summary(model1)

model2 <- lmer(week_prop_1 ~ week_stringency + (1 | Country), data=weekly)
summary(model2)

model3 <- lmer(week_prop_1 ~ week_rel_stringency + (1 | Country), data=weekly)
summary(model3)

model4 <- lmer(week_prop_2 ~ week_risk + (1 | Country), data=weekly)
summary(model4)

model5 <- lmer(week_prop_2 ~ week_stringency + (1 | Country), data=weekly)
summary(model5)

model6 <- lmer(week_prop_2 ~ week_rel_stringency + (1 | Country), data=weekly)
summary(model6)

stargazer::stargazer(model1, model2, model3, model4, model5, model6, type = "latex", out = "final_tables/3_weekly_classes.html", title = "Weekly Proportion", covariate.labels = c("Risk of Openness", "Stringency Index", "Relative stringency"), dep.var.labels = c("Class 1", "Class 2"))
```
## Relative Stringency Plots
```{r, fig.width=7,fig.height=10}
rel_stringency_plot <- ggplot(weekly, aes(x=date_time)) +
  geom_line(aes(y=prop_1, colour = "Class 1")) +  
  geom_line(aes(y=prop_2, colour = "Class 2")) +  theme_classic() +
  geom_line(aes(y=week_rel_stringency/10, colour = "Relative Stringency")) + xlab("Date") + ylab("Weekly Proportion")  +
    
  scale_y_continuous(
    
    # Features of the first axis
    name = "Weekly Class Percentage",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*10, name="Stringency Index") 
  ) 




# Column chart for each type of reaction
rel_stringency_plot <- rel_stringency_plot +
        facet_wrap(~Country, nrow = 5, scales = "free") 

rel_stringency_plot
```


# Main Results
Run week lag
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(week_class_1_lag = lag(week_prop_1)) %>%
  mutate(week_class_2_lag = lag(week_prop_2))
  
```
Run two week lag
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(week_class_1_lag2 = lag(week_prop_1, n = 2L)) %>%
  mutate(week_class_2_lag2 = lag(week_prop_2, n = 2L))
  
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(week_class_1_lag3 = lag(week_prop_1, n = 3L)) %>%
  mutate(week_class_2_lag3 = lag(week_prop_2, n = 3L))
  
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(week_class_1_lag4 = lag(week_prop_1, n = 4L)) %>%
  mutate(week_class_2_lag4 = lag(week_prop_2, n = 4L))
  
```

```{r}
model1 <- lmer(week_rel_stringency ~ week_oth_stringency + week_prop_1 + week_prop_2 + (1 | Country), data=weekly)
summary(model1)

model2 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag + week_class_2_lag + (1 | Country), data=weekly)
summary(model2)

model3 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag2 + week_class_2_lag2 + (1 | Country), data=weekly)
summary(model3)

model4 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag3 + week_class_2_lag3 + (1 | Country), data=weekly)
summary(model4)

model5 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag4 + week_class_2_lag4 + (1 | Country), data=weekly)
summary(model5)

model6 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag + week_class_2_lag + week_class_1_lag2 + week_class_2_lag2 + (1 | Country), data=weekly)
summary(model6)

model7 <- lmer(week_rel_stringency ~ week_oth_stringency + week_class_1_lag3 + week_class_2_lag3 +  week_class_1_lag4 + week_class_2_lag4 + (1 | Country), data=weekly)
summary(model7)

stargazer::stargazer(model1,model2,model3,model4,model5,model6, model7, type = "latex", out = "final_tables/4_static.html", title = "Weekly Proportion", covariate.labels = c("Average Western Stringency", "Class 1 Percent", "Class 2 Percent","Class 1: 1 Week Lag", "Class 2: 1 Week Lag","Class 1: 2 Week Lag", "Class 2: 2 Week Lag","Class 1: 3 Week Lag", "Class 2: 3 Week Lag","Class 1: 4 Week Lag", "Class 2: 4 Week Lag"), dep.var.labels = c("Relative Stringency"))
```
## Change regressions
Weekly Change
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_week_class_1 = week_prop_1 - lag(week_prop_1)) %>%
  mutate(change_week_class_2 = week_prop_2 - lag(week_prop_2)) %>%
  mutate(change_rel_stringency = week_rel_stringency - lag(week_rel_stringency)) %>%
  mutate(change_oth_stringency = week_oth_stringency - lag(week_oth_stringency))
```

Lag by 1 week
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_class_1_lag = lag(change_week_class_1)) %>%
  mutate(change_class_2_lag = lag(change_week_class_2)) 

```
Lag by 2 week
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_class_1_lag2 = lag(change_week_class_1,n=2L)) %>%
  mutate(change_class_2_lag2 = lag(change_week_class_2,n=2L)) 

```
Lag by 3 week
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_class_1_lag3 = lag(change_week_class_1,n=3L)) %>%
  mutate(change_class_2_lag3 = lag(change_week_class_2,n=3L)) 

```
Lag by 4 week
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_class_1_lag4 = lag(change_week_class_1,n=4L)) %>%
  mutate(change_class_2_lag4 = lag(change_week_class_2,n=4L)) 

```


```{r}
m1 <- lmer(change_rel_stringency ~ change_oth_stringency + change_week_class_1 + change_week_class_2 + (1 | Country), data=weekly)
summary(m1)
m2 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag + (1 | Country), data=weekly)
summary(m2)
m3 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag + change_class_2_lag + (1 | Country), data=weekly)
summary(m3)
m4 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag2 + (1 | Country), data=weekly)
summary(m4)
m5 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag2 + change_class_2_lag2 + (1 | Country), data=weekly)
summary(m5)
m6 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag3 + (1 | Country), data=weekly)
summary(m6)
m7 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag3 + change_class_2_lag3 + (1 | Country), data=weekly)
summary(m7)
m8 <- lmer(change_rel_stringency ~ change_oth_stringency + change_class_1_lag4 + change_class_2_lag4 + (1 | Country), data=weekly)
summary(m8)

stargazer::stargazer(m1,m2,m3,m4,m5,m6,m7,m8, type = "latex", out = "final_tables/5_change_oriented.html", title = "Weekly Proportion", covariate.labels = c("Change in Average Western Stringency", "Change in Class 1 Percent", "Change in Class 2 Percent", "Change in Class 1: 1 Week Lag", "Change in Class 2: 1 Week Lag","Change in Class 1: 2 Week Lag", "Change in Class 2: 2 Week Lag","Change in Class 1: 3 Week Lag", "Change in Class 2: 3 Week Lag","Change in Class 1: 4 Week Lag", "Change in Class 2: 4 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```
## Histogram to see variable distributions
```{r}
ggplot(weekly) + geom_histogram(aes(x=change_week_class_1), bins =40, fill = "darkgreen") + theme_classic()
ggplot(weekly) + geom_histogram(aes(x=change_week_class_2), bins =40, fill = "darkgreen") + theme_classic()
ggplot(weekly) + geom_histogram(aes(x=change_rel_stringency), bins =40, fill = "darkgreen") + theme_classic()
ggplot(weekly) + geom_histogram(aes(x=change_oth_stringency), bins =40, fill = "darkgreen") + theme_classic()

```

## Binary Outcome Variable
```{r}
weekly$binary_rel_stringency <- ifelse(weekly$change_rel_stringency>0, 1, 0)
weekly$binary_rel_stringency <- as.factor(weekly$binary_rel_stringency)
```

```{r}
m1 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_week_class_1 + change_week_class_2 + (1 | Country), data=weekly, family=binomial(link="logit"))

m2 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag + (1 | Country), data=weekly, family=binomial(link="logit"))

m3 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag + change_class_2_lag + (1 | Country), data=weekly, family=binomial(link="logit"))

m4 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag2 + (1 | Country), data=weekly, family=binomial(link="logit"))

m5 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag2 + change_class_2_lag2 + (1 | Country), data=weekly, family=binomial(link="logit"))

m6 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag3 + (1 | Country), data=weekly, family=binomial(link="logit"))

m7 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag3 + change_class_2_lag3 + (1 | Country), data=weekly, family=binomial(link="logit"))

m8 <- glmer(binary_rel_stringency ~ change_oth_stringency + change_class_1_lag4 + change_class_2_lag4 + (1 | Country), data=weekly, family=binomial(link="logit"))


stargazer::stargazer(m1,m2,m3,m4,m5,m6,m7,m8, type = "latex", out = "final_tables/6_binary_change.html", title = "Logit: Weekly Proportion", covariate.labels = c("Change in Average Western Stringency", "Change in Class 1 Percent", "Change in Class 2 Percent", "Change in Class 1: 1 Week Lag", "Change in Class 2: 1 Week Lag","Change in Class 1: 2 Week Lag", "Change in Class 2: 2 Week Lag","Change in Class 1: 3 Week Lag", "Change in Class 2: 3 Week Lag","Change in Class 1: 4 Week Lag", "Change in Class 2: 4 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```


## Ordinal Independent Variable
```{r}
colnames(weekly)
weekly$binary_change_1 <- ifelse(weekly$change_week_class_1 > 0, 1, 0)
weekly$binary_change_1_lag <- ifelse(weekly$change_class_1_lag > 0, 1, 0)
weekly$binary_change_2 <- ifelse(weekly$change_week_class_2 > 0, 1, 0)
weekly$binary_change_2_lag <- ifelse(weekly$change_class_2_lag > 0, 1, 0)

weekly$ordinal_change_1 <-weekly$binary_change_1 + weekly$binary_change_1_lag
weekly$ordinal_change_2 <-weekly$binary_change_2 + weekly$binary_change_2_lag

weekly$ordinal_change_1 <- as.factor(weekly$ordinal_change_1)
weekly$ordinal_change_2 <- as.factor(weekly$ordinal_change_2)
```

Making lags
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(ordinal_change_1_lag = lag(ordinal_change_1)) %>%
  mutate(ordinal_change_2_lag = lag(ordinal_change_2))
  
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(ordinal_change_1_lag_2 = lag(ordinal_change_1, n = 2L)) %>%
  mutate(ordinal_change_2_lag_2 = lag(ordinal_change_2, n = 2L))
  
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(ordinal_change_1_lag_3 = lag(ordinal_change_1, n = 3L)) %>%
  mutate(ordinal_change_2_lag_3 = lag(ordinal_change_2, n = 3L))
  
```

```{r}
library(lme4)
# Run random intercept model
m1 <- lmer(change_rel_stringency ~ change_oth_stringency + ordinal_change_1 + ordinal_change_2 + (1 | Country), data=weekly)
m2 <- lmer(change_rel_stringency ~ change_oth_stringency + ordinal_change_1_lag + (1 | Country), data=weekly)
m3 <- lmer(change_rel_stringency ~ change_oth_stringency + ordinal_change_1_lag + ordinal_change_2_lag + (1 | Country), data=weekly)
m4 <- lmer(change_rel_stringency ~ change_oth_stringency + ordinal_change_1_lag_2 + (1 | Country), data=weekly)
m5 <- lmer(change_rel_stringency ~ change_oth_stringency + ordinal_change_1_lag_2 + ordinal_change_2_lag_2 + (1 | Country), data=weekly)

stargazer::stargazer(m1,m2,m3,m4,m5, type = "latex", out = "final_tables/7_change_ordinal.html", title = "Weekly Proportion Change", covariate.labels = c("Change in Average Western Stringency", "Class 1 Ambiguous","Class 1 Increase", "Class 2 Ambiguous","Class 2 Increase","Class 1 Ambiguous: Week Lag","Class 1 Increase: Week Lag", "Class 2 Ambiguous: Week Lag","Class 2 Increase: Week Lag","Class 1 Ambiguous: 2 Week Lag","Class 1 Increase: 2 Week Lag", "Class 2 Ambiguous: 2 Week Lag","Class 2 Increase: 2 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```
## Table for ordinal

## Tables for ordinal change
```{r}
pro_table <- table(weekly$ordinal_change_1_lag, weekly$binary_rel_stringency)
anti_table <- table(weekly$ordinal_change_2_lag, weekly$binary_rel_stringency)
# 
pro_table 
anti_table 

uk <- weekly %>% filter(Country=="United Kingdom")
# by country - UK
pro_table <- table(uk$ordinal_change_1_lag, uk$binary_rel_stringency)
anti_table <- table(uk$ordinal_change_2_lag, uk$binary_rel_stringency)
# 
pro_table 
anti_table 
```


## Class Proportion Regression
```{r}
colnames(weekly)
# change 0 to a small value - 1
weekly$sum_1 <- ifelse(weekly$sum_1 == 0, 1, weekly$sum_1)
weekly$sum_2 <- ifelse(weekly$sum_2 == 0, 1, weekly$sum_2)

weekly$ratio <- weekly$sum_2/weekly$sum_1

```

```{r}
ggplot(weekly) + geom_histogram(aes(x=ratio), bins =50, fill = "darkgreen") + theme_classic()
ggplot(weekly) + geom_histogram(aes(x=log(ratio)), bins =50, fill = "darkgreen") + theme_classic()
```




```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change_ratio = ratio - lag(ratio))

weekly <- weekly %>%
  group_by(Country) %>%
  mutate(lag_change_ratio = lag(change_ratio))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(lag2_change_ratio = lag(change_ratio, n=2L))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(lag3_change_ratio = lag(change_ratio, n =3L))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(lag4_change_ratio = lag(change_ratio, n=4L))

```

```{r}
library(lme4)
# Run random intercept model
m1 <- lmer(change_rel_stringency ~ change_oth_stringency + change_ratio + (1 | Country), data=weekly)
m2 <- lmer(change_rel_stringency ~ change_oth_stringency + lag_change_ratio + (1 | Country), data=weekly)
m3 <- lmer(change_rel_stringency ~ change_oth_stringency + lag2_change_ratio + (1 | Country), data=weekly)
m4 <- lmer(change_rel_stringency ~ change_oth_stringency + lag3_change_ratio + (1 | Country), data=weekly)
m5 <- lmer(change_rel_stringency ~ change_oth_stringency + lag4_change_ratio + (1 | Country), data=weekly)

stargazer::stargazer(m1,m2,m3,m4,m5, type = "latex", out = "final_tables/15_change_ratio.html", title = "Weekly Proportion Change", covariate.labels = c("Change in Average Western Stringency", "Change in Class Proportion", "Change in Class Proportion: Week Lag", "Change in Class Proportion: 2 Week Lag", "Change in Class Proportion: 3 Week Lag", "Change in Class Proportion: 4 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```

```{r}
uk <- weekly %>% filter(Country == "United Kingdom")
library(lme4)
# Run random intercept model
m1 <- lm(change_rel_stringency ~ change_oth_stringency + change_ratio , data=uk)
m2 <- lm(change_rel_stringency ~ change_oth_stringency + lag_change_ratio , data=uk)
m3 <- lm(change_rel_stringency ~ change_oth_stringency + lag2_change_ratio , data=uk)
m4 <- lm(change_rel_stringency ~ change_oth_stringency + lag3_change_ratio , data=uk)
m5 <- lm(change_rel_stringency ~ change_oth_stringency + lag4_change_ratio , data=uk)

stargazer::stargazer(m1,m2,m3,m4,m5, type = "latex", out = "final_tables/16_uk_change_ratio.html", title = "United Kingdom: Weekly Proportion Change", covariate.labels = c("Change in Average Western Stringency", "Change in Class Proportion", "Change in Class Proportion: Week Lag", "Change in Class Proportion: 2 Week Lag", "Change in Class Proportion: 3 Week Lag", "Change in Class Proportion: 4 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```

```{r}
library(lme4)
# Run random intercept model
m1 <- lm(change_rel_stringency ~  change_ratio , data=uk)
m2 <- lm(change_rel_stringency ~  lag_change_ratio , data=uk)
m3 <- lm(change_rel_stringency ~  lag2_change_ratio , data=uk)
m4 <- lm(change_rel_stringency ~  lag3_change_ratio , data=uk)
m5 <- lm(change_rel_stringency ~  lag4_change_ratio , data=uk)

stargazer::stargazer(m1,m2,m3,m4,m5, type = "latex", out = "final_tables/16a_uk_change_ratio_no_cntrl.html", title = "United Kingdom: Weekly Proportion Change", covariate.labels = c("Change in Average Western Stringency", "Change in Class Proportion", "Change in Class Proportion: Week Lag", "Change in Class Proportion: 2 Week Lag", "Change in Class Proportion: 3 Week Lag", "Change in Class Proportion: 4 Week Lag"), dep.var.labels = c("Change in Relative Stringency"))

```



## Summary Tables for each country
```{r}
weekly$binary_lag_diff <- ifelse(weekly$lag_change_ratio < 0, 0, 1)
diff_table <- table(weekly$binary_lag_diff, weekly$binary_rel_stringency)
diff_table 

uk <- weekly %>% filter(Country=="United Kingdom")
# by country - UK
diff_table <- table(uk$binary_lag_diff, uk$binary_rel_stringency)
diff_table 

aus <- weekly %>% filter(Country=="Australia")
# by country - UK
diff_table <- table(aus$binary_lag_diff, aus$binary_rel_stringency)
diff_table 

can <- weekly %>% filter(Country=="Canada")
# by country - UK
diff_table <- table(can$binary_lag_diff, can$binary_rel_stringency)
diff_table 

ire <- weekly %>% filter(Country=="Ireland")
# by country - UK
diff_table <- table(ire$binary_lag_diff, ire$binary_rel_stringency)
diff_table 

nz <- weekly %>% filter(Country=="New Zealand")
# by country - UK
diff_table <- table(nz$binary_lag_diff, nz$binary_rel_stringency)
diff_table 

```



## Graphing the class difference
```{r, fig.width=7,fig.height=10}
difference_plot <- ggplot(weekly, aes(x=date_time)) +
  geom_line(aes(y=ratio, colour = "Class Difference")) + theme_classic() +
  geom_line(aes(y=week_rel_stringency/10, colour = "Relative Stringency")) + xlab("Date") + ylab("Weekly Proportion")  +
    
  scale_y_continuous(
    
    # Features of the first axis
    name = "Weekly Class Difference",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*10, name="Stringency Index") 
  ) 




# Column chart for each type of reaction
difference_plot <- difference_plot +
        facet_wrap(~Country, nrow = 5, scales = "free") 

difference_plot
```



## Robustness Checks
```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change1_rel_stringency = lag(change_rel_stringency))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change2_rel_stringency = lag(change_rel_stringency, n=2L))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change3_rel_stringency = lag(change_rel_stringency, n =3L))
```

```{r}
weekly <- weekly %>%
  group_by(Country) %>%
  mutate(change4_rel_stringency = lag(change_rel_stringency, n=4L))
```

```{r}
uk <- weekly %>% filter(Country == "United Kingdom")

library(lme4)
m1 <- lm(change_ratio ~ change1_rel_stringency, data=uk)
m2 <- lm(change_ratio ~ change2_rel_stringency, data=uk)
m3 <- lm(change_ratio ~ change3_rel_stringency, data=uk)
m4 <- lm(change_ratio ~ change4_rel_stringency, data=uk)

stargazer::stargazer(m1,m2,m3,m4, type = "latex", out = "final_tables/13_uk_robustness.html", title = "United Kingdom: Inverse Causation", covariate.labels = c("Change in Relative Stringency", "Change in Relative Stringency: Week Lag", "Change in Relative Stringency: 2 Week Lag", "Change in Relative Stringency: 3 Week Lag", "Change in Relative Stringency: 4 Week Lag"), dep.var.labels = c("Change in Class Proportion"))

```

